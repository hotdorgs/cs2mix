<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS2 Mix Balancer - Hotdorgs Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Rajdhani', 'sans-serif'],
                    },
                    colors: {
                        dark: { 900: '#0b0f19', 800: '#101623', 700: '#1a2236' },
                        ct: '#4b69ff',
                        tr: '#eb9e34'
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0b0f19;
            color: #f1f5f9;
            background-image: radial-gradient(circle at 50% 0%, #1a2236 0%, #0b0f19 70%);
            min-height: 100vh;
        }
        
        .glass-panel {
            background: rgba(16, 22, 35, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .glass-header {
            background: rgba(11, 15, 25, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn-primary { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .btn-primary:hover:not(:disabled) { 
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); 
            transform: translateY(-1px); 
        }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        @keyframes pulse-glow { 
            0%, 100% { opacity: 1; box-shadow: 0 0 5px currentColor; } 
            50% { opacity: 0.6; box-shadow: 0 0 10px currentColor; } 
        }
        .animate-status { animation: pulse-glow 2s infinite; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader { border: 2px solid rgba(255,255,255,0.1); border-top: 2px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }

        /* Dynamic Island - Login Positioning */
        .login-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            z-index: 70;
            width: 20rem;
            transform-origin: top right;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            pointer-events: none;
        }
        .login-dropdown.active {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }

        /* Dynamic Island - Copy Center */
        .dynamic-island-center {
            position: fixed;
            top: 5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            display: flex;
            justify-content: center;
        }
        .island-copy {
            width: 0;
            transform: scale(0.9);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            background: rgba(16, 22, 35, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            border-radius: 1.25rem;
        }
        .island-copy.active {
            max-height: 600px;
            width: 380px;
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
            padding: 1.25rem;
        }

        /* Tooltip */
        .tooltip-trigger:hover .tooltip-content { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }
        .tooltip-content { opacity: 0; visibility: hidden; transition: all 0.2s ease; transform: translate(-50%, 0px); }

        /* Toasts */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 0.3s ease-in; }

        .prose strong { color: #fff; font-weight: 700; }
        .prose p { margin-bottom: 0.5rem; color: #cbd5e1; }
        .ai-disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
    </style>
</head>
<body class="flex flex-col selection:bg-blue-500 selection:text-white overflow-x-hidden">

    <!-- Navbar -->
    <nav class="glass-header sticky top-0 w-full z-50">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <!-- Logo -->
            <div class="flex items-center gap-3">
                <div class="relative group cursor-pointer">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-600 to-purple-600 rounded-full opacity-50 group-hover:opacity-100 blur transition duration-500"></div>
                    <img src="Hot Dorgs.jpg" onerror="this.src='https://ui-avatars.com/api/?name=HD&background=1e293b&color=fff'" alt="Logo" class="relative w-10 h-10 rounded-full border border-white/10 object-cover shadow-lg">
                </div>
                <div class="flex flex-col">
                    <h1 class="font-display font-bold text-lg tracking-tight leading-none text-white">MIX <span class="text-blue-500 uppercase">Balancer</span></h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Powered by Hotdorgs</p>
                </div>
            </div>

            <!-- Right Actions -->
            <div class="flex items-center gap-4">
                <!-- Status -->
                <div class="hidden sm:flex items-center gap-2 bg-slate-900/50 px-3 py-1.5 rounded-full border border-white/5 shadow-inner">
                    <div id="statusLed" class="w-2 h-2 rounded-full bg-slate-600 transition-colors duration-500"></div>
                    <span id="statusLabel" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Conectando...</span>
                </div>
                
                <!-- Auth Container -->
                <div class="relative">
                    <div id="authActions" class="flex gap-2">
                        <button id="navLoginBtn" onclick="toggleLoginModal()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white px-4 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2 border border-white/5">
                            <i class="fas fa-lock"></i> <span>LOGIN</span>
                        </button>

                        <div id="adminControls" class="hidden flex gap-2">
                            <button onclick="openConfig()" class="bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 p-2 rounded-xl transition border border-blue-500/20" title="Configurações">
                                <i class="fas fa-cog"></i>
                            </button>
                            <button onclick="performLogout()" class="bg-red-600/10 hover:bg-red-600/20 text-red-400 p-2 rounded-xl transition border border-red-500/20" title="Sair">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Login Modal (Anchored to Button) -->
                    <div id="loginModal" class="glass-panel rounded-2xl p-5 shadow-2xl login-dropdown">
                        <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-2">
                            <h3 class="text-xs font-bold text-white uppercase tracking-wider flex items-center gap-2">
                                <i class="fas fa-shield-alt text-blue-500"></i> Área Administrativa
                            </h3>
                            <button onclick="toggleLoginModal()" class="text-slate-500 hover:text-white transition"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="space-y-3">
                            <input type="text" id="adminUser" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition" placeholder="Email">
                            <input type="password" id="adminPass" class="w-full bg-slate-950/50 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-blue-500 outline-none transition" placeholder="Senha">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="rememberMe" class="accent-blue-500 w-3 h-3 rounded bg-slate-800 border-slate-600">
                                <label for="rememberMe" class="text-[10px] text-slate-400 cursor-pointer">Lembrar acesso</label>
                            </div>
                            <button onclick="checkLogin()" class="w-full btn-primary text-white py-2 rounded-lg font-bold text-xs shadow-lg mt-2 flex justify-center items-center gap-2">
                                ENTRAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dynamic Island: COPY (Center Aligned) -->
    <div class="dynamic-island-center">
        <div id="islandCopy" class="island-copy flex flex-col">
            <div class="flex justify-between items-center mb-3 border-b border-white/5 pb-2">
                <h3 class="text-xs font-bold text-white uppercase tracking-wider flex items-center gap-2">
                    <i class="fas fa-clipboard text-emerald-500"></i> Prévia da Cópia
                </h3>
                <button onclick="toggleIsland('copy')" class="text-slate-500 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="bg-slate-950/50 rounded-lg p-3 border border-slate-800 mb-3 overflow-hidden">
                <pre id="copyPreviewText" class="text-[10px] text-slate-300 font-mono whitespace-pre-wrap break-words max-h-[300px] overflow-y-auto custom-scroll"></pre>
            </div>
            <button onclick="confirmCopy()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2.5 rounded-lg font-bold text-xs shadow-lg flex justify-center items-center gap-2 transition">
                <i class="fas fa-copy"></i> CONFIRMAR CÓPIA
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow pt-8 pb-10 px-4 w-full max-w-7xl mx-auto">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">
            
            <!-- Left: Lobby -->
            <div class="lg:col-span-8 space-y-6">
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/5 rounded-full blur-3xl pointer-events-none -mr-16 -mt-16"></div>

                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 relative z-10">
                        <div>
                            <h2 class="text-2xl font-display font-bold text-white flex items-center gap-2">
                                <i class="fas fa-users text-blue-500"></i> LOBBY
                                <span class="bg-slate-800 text-slate-300 text-xs px-2 py-0.5 rounded-full border border-slate-700 font-mono ml-2">
                                    <span id="countDisplay">0</span>/10
                                </span>
                            </h2>
                            <p class="text-xs text-slate-400 mt-1">Gerencie a lista de presença.</p>
                        </div>
                        
                        <div class="flex gap-2 w-full sm:w-auto">
                            <button id="btnManualRefresh" onclick="manualRefresh()" class="p-2.5 text-slate-400 hover:text-white bg-slate-800/50 hover:bg-slate-700 rounded-lg border border-slate-700 transition disabled:opacity-50 disabled:cursor-not-allowed group relative" title="Atualizar (Sincroniza Ratings)">
                                <i class="fas fa-sync-alt" id="refreshIcon"></i>
                                <span class="absolute top-full left-1/2 transform -translate-x-1/2 mt-1 bg-black/80 text-[9px] text-white px-2 py-1 rounded hidden group-disabled:block whitespace-nowrap">Atualizando...</span>
                            </button>
                            <button id="btnAddPlayer" onclick="openAddPlayerModal()" class="hidden flex-1 sm:flex-none bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-lg font-bold text-sm transition shadow-lg flex items-center justify-center gap-2">
                                <i class="fas fa-plus"></i> ADD PLAYER
                            </button>
                        </div>
                    </div>

                    <div id="playersList" class="grid grid-cols-1 md:grid-cols-2 gap-3 min-h-[100px]"></div>

                    <div class="mt-8 pt-6 border-t border-white/5 flex flex-col md:flex-row gap-4 items-center justify-between">
                        <!-- AI Toggle -->
                        <div class="flex items-center gap-3 bg-black/20 px-4 py-2 rounded-lg border border-white/5 w-full md:w-auto">
                            <label class="inline-flex items-center cursor-pointer group" id="aiToggleLabel">
                                <input type="checkbox" id="useAiToggle" class="sr-only peer" onchange="toggleAiSelect()" disabled>
                                <div class="relative w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-slate-300 after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600 peer-checked:after:bg-white"></div>
                                <span id="aiToggleText" class="ms-2 text-xs font-bold text-slate-500 transition-colors ai-disabled">IA (Dev)</span>
                            </label>
                            <div id="aiSelectContainer" class="hidden">
                                <select id="mainAiProvider" class="bg-slate-900 border border-purple-500/30 text-[10px] text-purple-300 rounded px-2 py-1 outline-none h-6">
                                    <option value="gemini">Gemini</option>
                                    <option value="groq">Groq</option>
                                </select>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-2 w-full md:w-auto flex-wrap justify-end">
                            <label class="flex items-center gap-2 cursor-pointer bg-slate-800/50 px-3 py-2.5 rounded-lg border border-slate-700 hover:bg-slate-700 transition" title="Atualizar ratings antes de sortear">
                                <input type="checkbox" id="chkAutoUpdate" class="accent-emerald-500 rounded w-4 h-4 cursor-pointer" checked>
                                <span class="text-xs font-bold text-slate-300">Auto-Update</span>
                            </label>
                            <button id="btnClear" onclick="clearCurrentMatch()" class="hidden flex-1 md:flex-none px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg text-sm font-bold border border-slate-700 transition">
                                LIMPAR
                            </button>
                            <button id="btnBalance" onclick="handleBalance()" class="hidden flex-[2] md:flex-none btn-primary text-white px-8 py-2.5 rounded-lg text-sm font-bold shadow-lg flex items-center justify-center gap-2">
                                <i class="fas fa-balance-scale"></i> EQUILIBRAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Results -->
            <div class="lg:col-span-4 h-full">
                <div id="placeholderResult" class="glass-panel rounded-2xl p-8 flex flex-col items-center justify-center text-center h-full min-h-[400px] border-dashed">
                    <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 text-slate-600"><i class="fas fa-gamepad text-2xl"></i></div>
                    <h3 class="text-lg font-bold text-slate-300">Aguardando Sorteio</h3>
                    <p class="text-sm text-slate-500 mt-2 max-w-[200px]">Adicione 10 jogadores e clique em equilibrar.</p>
                </div>

                <div id="resultsArea" class="hidden space-y-4">
                    <div class="flex justify-between items-end mb-2 px-1">
                        <h3 class="text-lg font-display font-bold text-white">MATCHUP</h3>
                        <span id="diffBadge" class="text-[10px] font-mono text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-700">Diff: 0.00</span>
                    </div>

                    <!-- Time A -->
                    <div class="glass-panel rounded-xl overflow-hidden border-l-4 border-l-ct shadow-lg relative group">
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                        <div class="bg-slate-900/50 p-3 flex justify-between items-center border-b border-white/5">
                            <span class="font-bold text-blue-400 text-xs tracking-widest uppercase">Time A</span>
                            <span id="avgA" class="text-[10px] font-mono bg-blue-500/10 text-blue-300 px-2 py-0.5 rounded border border-blue-500/20">Avg: 0.00</span>
                        </div>
                        <div id="listA" class="p-1"></div>
                    </div>

                    <div class="relative flex items-center justify-center py-2 opacity-50">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-700"></div></div>
                        <div class="relative bg-slate-900 px-2 text-xs text-slate-500 font-display font-bold">VS</div>
                    </div>

                    <!-- Time B -->
                    <div class="glass-panel rounded-xl overflow-hidden border-l-4 border-l-tr shadow-lg relative group">
                        <div class="absolute inset-0 bg-gradient-to-r from-orange-600/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                        <div class="bg-slate-900/50 p-3 flex justify-between items-center border-b border-white/5">
                            <span class="font-bold text-orange-400 text-xs tracking-widest uppercase">Time B</span>
                            <span id="avgB" class="text-[10px] font-mono bg-orange-500/10 text-orange-300 px-2 py-0.5 rounded border border-orange-500/20">Avg: 0.00</span>
                        </div>
                        <div id="listB" class="p-1"></div>
                    </div>

                    <div id="reservesBox" class="hidden glass-panel rounded-xl p-3 border border-slate-700/50 bg-black/20">
                        <div class="text-[10px] font-bold text-slate-500 uppercase mb-2 flex items-center gap-2"><i class="fas fa-chair"></i> Reservas / Próximos</div>
                        <div id="listReserves" class="flex flex-wrap gap-2"></div>
                    </div>

                    <div class="grid grid-cols-1 gap-3 pt-2">
                        <button id="coachBtn" onclick="handleAiCoach()" class="w-full bg-slate-800 border border-slate-700 text-slate-500 py-3 rounded-lg font-bold text-xs cursor-not-allowed flex items-center justify-center gap-2 transition relative overflow-hidden group disabled:opacity-50 disabled:cursor-not-allowed">
                            <div class="absolute inset-0 bg-gradient-to-r from-purple-600 to-pink-600 opacity-0 transition-opacity duration-300 group-hover:opacity-100 z-0"></div>
                            <span class="relative z-10 flex items-center gap-2 group-hover:text-white transition-colors">
                                <i class="fas fa-brain"></i> <span id="coachBtnText">COACH IA</span>
                            </span>
                        </button>

                        <div class="relative w-full">
                            <button id="copyBtn" onclick="prepareCopy()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white py-3 rounded-lg font-bold text-xs border border-slate-600 transition flex items-center justify-center gap-2">
                                <i class="fas fa-copy"></i> COPIAR TEXTO
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-800/50 py-6 mt-auto bg-[#0b0f19]">
        <div class="max-w-7xl mx-auto px-4 flex justify-between items-center text-[10px] text-slate-600 uppercase tracking-wider">
            <span>&copy; 2026 CS2 Mix Balancer</span>
            <span class="flex items-center gap-2"><img src="Hot Dorgs.jpg" onerror="this.src='https://ui-avatars.com/api/?name=HD&background=1e293b&color=fff'" class="w-6 h-6 rounded-full grayscale opacity-50" alt="HD"><span>hotdorgs Production</span></span>
        </div>
    </footer>

    <!-- Toasts -->
    <div id="toastContainer" class="fixed bottom-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Loading -->
    <div id="loadingModal" class="fixed inset-0 bg-black/90 hidden items-center justify-center z-[200] backdrop-blur-sm flex-col">
        <div class="loader mb-6"></div>
        <h2 class="text-white text-xl font-bold" id="loadingTitle">Calculando...</h2>
        <p class="text-slate-500 text-sm mt-2" id="loadingDesc"></p>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="hidden fixed inset-0 bg-black/80 z-[100] items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden">
            <div class="bg-slate-800/50 p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-white font-bold"><i class="fas fa-cog text-slate-400 mr-2"></i> Configurações</h3>
                <button onclick="closeModal('configModal')" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-6 max-h-[70vh] overflow-y-auto custom-scroll">
                
                <!-- Permissões Globais (Visitantes) -->
                <div>
                    <h4 class="text-xs font-bold text-emerald-400 uppercase mb-3">Permissões de Usuário (Público)</h4>
                    <div class="grid grid-cols-2 gap-3 bg-black/20 p-3 rounded-lg border border-slate-700/50">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="permAdd" class="accent-emerald-500 rounded">
                            <span class="text-xs text-slate-300">Adicionar Player</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="permEdit" class="accent-emerald-500 rounded">
                            <span class="text-xs text-slate-300">Editar Player</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="permDel" class="accent-emerald-500 rounded">
                            <span class="text-xs text-slate-300">Excluir Player</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="permBalance" class="accent-emerald-500 rounded">
                            <span class="text-xs text-slate-300">Equilibrar</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="permClear" class="accent-emerald-500 rounded">
                            <span class="text-xs text-slate-300">Limpar</span>
                        </label>
                    </div>
                </div>

                <!-- Beta Features -->
                <div>
                    <h4 class="text-xs font-bold text-purple-400 uppercase mb-3">Funcionalidades Beta (IA)</h4>
                    <div class="space-y-3 bg-black/20 p-3 rounded-lg border border-slate-700/50">
                        <label class="flex items-center justify-between cursor-pointer group">
                            <span class="text-sm text-slate-300">Habilitar Balanceamento IA</span>
                            <input type="checkbox" id="flagAiBalance" class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-purple-600">
                        </label>
                        <label class="flex items-center justify-between cursor-pointer group">
                            <span class="text-sm text-slate-300">Habilitar Coach IA</span>
                            <input type="checkbox" id="flagAiCoach" class="w-4 h-4 rounded border-slate-600 bg-slate-800 text-purple-600">
                        </label>
                    </div>
                </div>

                <!-- Text Config -->
                <div>
                    <h4 class="text-xs font-bold text-blue-400 uppercase mb-3">Textos</h4>
                    <div class="space-y-3">
                        <input type="text" id="cfgCopyTitle" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white" placeholder="Título da Cópia">
                        <input type="text" id="cfgCopyFooter" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white" placeholder="Rodapé da Cópia">
                    </div>
                </div>

                <!-- API Keys -->
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">API Keys (Segredo)</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] text-slate-500 uppercase font-bold block mb-1">Provedor Ativo</label>
                            <select id="aiProvider" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                                <option value="gemini">Google Gemini</option>
                                <option value="groq">Groq Cloud</option>
                            </select>
                        </div>
                        <input type="password" id="cfgGeminiKey" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white transition hover:border-blue-500 focus:border-blue-500 outline-none" placeholder="Chave Gemini (AI Studio)">
                        <input type="password" id="cfgGroqKey" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white transition hover:border-orange-500 focus:border-orange-500 outline-none" placeholder="Chave Groq Cloud">
                        
                        <!-- Leetify Token Field -->
                        <div class="relative">
                             <label class="text-[10px] text-emerald-500 uppercase font-bold block mb-1">Leetify Integration</label>
                             <input type="password" id="cfgLeetifyKey" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white transition hover:border-emerald-500 focus:border-emerald-500 outline-none" placeholder="Leetify API Token">
                             <p class="text-[9px] text-slate-500 mt-1">* A chave do Leetify será pública para permitir updates dos visitantes.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Firebase Local -->
                <div class="pt-4 border-t border-slate-700">
                    <h4 class="text-xs font-bold text-orange-400 uppercase mb-3">Conexão</h4>
                    <input type="text" id="fbApiKey" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-xs text-white" placeholder="Firebase API Key (Opcional)">
                    <div class="mt-2 text-right"><button onclick="clearLocalStorage()" class="text-xs text-red-500 hover:text-red-400 underline">Resetar Local</button></div>
                </div>
            </div>
            <div class="bg-slate-800/50 p-4 border-t border-slate-700 flex justify-end gap-3">
                <button onclick="closeModal('configModal')" class="px-4 py-2 text-slate-400 hover:text-white text-sm transition">Cancelar</button>
                <button onclick="saveConfig()" class="btn-primary text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg">SALVAR</button>
            </div>
        </div>
    </div>
    
    <!-- Player Modal -->
    <div id="playerModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center backdrop-blur-sm p-4 transition-opacity">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-sm shadow-2xl transform transition-all scale-95 opacity-0 modal-content relative overflow-hidden">
            <!-- Form View -->
            <div id="playerFormView" class="w-full h-full">
                <div class="p-5 border-b border-slate-800 flex justify-between items-center">
                    <h3 class="text-white font-bold text-sm uppercase tracking-wide flex items-center gap-2">
                        <i class="fas fa-user-plus text-blue-500"></i> <span id="modalTitle">Adicionar Jogador</span>
                    </h3>
                    <button onclick="closeModal('playerModal')" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-5 space-y-4">
                    <input type="hidden" id="playerId">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Nickname</label>
                        <input type="text" id="inputName" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:border-blue-500 outline-none mt-1 placeholder-slate-700">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-emerald-400 uppercase tracking-wider">Link Leetify / Steam (Obrigatório)</label>
                        <input type="text" id="inputUrl" class="w-full bg-slate-950 border border-emerald-500/30 rounded-lg px-3 py-2 text-slate-300 text-xs focus:border-emerald-500 outline-none mt-1 placeholder-slate-700" placeholder="https://leetify.com/app/profile/...">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Rating</label>
                            <span class="text-[9px] text-emerald-500 uppercase font-bold animate-pulse hidden" id="autoUpdateLabel">Auto-Updating...</span>
                        </div>
                        <input type="number" id="inputRating" step="0.01" class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-emerald-400 font-mono text-lg focus:border-blue-500 outline-none placeholder-slate-700" placeholder="0.00">
                    </div>
                    <button onclick="savePlayer()" class="w-full btn-primary text-white py-3 rounded-lg font-bold text-xs uppercase tracking-widest shadow-lg mt-2">Salvar & Atualizar</button>
                </div>
            </div>

            <!-- Help View (Overlay) -->
            <div id="playerHelpView" class="hidden absolute inset-0 bg-slate-900 z-20 flex flex-col w-full h-full">
                <div class="p-5 border-b border-slate-800 flex justify-between items-center bg-slate-800/30">
                    <h3 class="text-white font-bold text-sm uppercase"><i class="fas fa-info-circle text-blue-500 mr-2"></i> Ajuda Leetify</h3>
                    <button onclick="toggleHelpView(false)" class="text-slate-400 hover:text-white text-xs font-bold uppercase">Voltar</button>
                </div>
                <div class="p-5 flex-1 overflow-y-auto">
                    <p class="text-xs text-slate-400 mb-4">Para encontrar seu rating, acesse seu perfil no Leetify. O número aparece logo abaixo do seu nome.</p>
                    <div class="bg-black/40 rounded-lg p-4 border border-slate-800 mb-4 flex flex-col items-center">
                        <i class="fas fa-chart-line text-4xl text-slate-600 mb-2"></i>
                        <span class="text-emerald-400 font-mono text-xl font-bold">+2.45</span>
                        <span class="text-[10px] text-slate-500 uppercase mt-1">Exemplo de Rating</span>
                    </div>
                    <a href="https://leetify.com/profile/" target="_blank" class="block w-full bg-slate-800 hover:bg-slate-700 text-center py-3 rounded-lg text-xs font-bold text-white transition border border-slate-700">
                        ABRIR LEETIFY.COM <i class="fas fa-external-link-alt ml-1"></i>
                    </a>
                </div>
                <div class="p-4 border-t border-slate-800">
                    <button onclick="toggleHelpView(false)" class="w-full bg-slate-800 text-slate-300 py-2 rounded-lg text-xs font-bold">Voltar para Edição</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help & AI Modals -->
    <div id="aiModal" class="hidden fixed inset-0 bg-black/90 z-[110] items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-900 border border-purple-500/50 rounded-2xl w-full max-w-lg shadow-2xl flex flex-col max-h-[85vh]">
            <div class="bg-gradient-to-r from-purple-900/50 to-slate-900 p-4 border-b border-purple-500/20 flex justify-between items-center">
                <h3 class="text-white font-bold"><i class="fas fa-robot text-purple-400 mr-2"></i> Coach IA</h3>
                <button onclick="closeModal('aiModal')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="aiContentBody" class="p-6 overflow-y-auto text-sm text-slate-300 space-y-4 custom-scroll"></div>
        </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-black/80 z-[130] items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2">Tem certeza?</h3>
            <p id="confirmMessage" class="text-slate-400 text-sm mb-6">Essa ação não pode ser desfeita.</p>
            <div class="flex gap-3 mt-4">
                <button onclick="closeModal('confirmModal')" class="flex-1 bg-slate-800 text-white py-2 rounded-lg text-sm font-bold">Não</button>
                <button id="btnConfirmYes" class="flex-1 bg-red-600 text-white py-2 rounded-lg text-sm font-bold">Sim</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, updateDoc, onSnapshot, query, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define global showToast
        window.showToast = (msg, type = 'info') => {
            const container = document.getElementById('toastContainer');
            if(!container) return;
            const el = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-600' : (type === 'success' ? 'bg-emerald-600' : 'bg-blue-600');
            const icon = type === 'error' ? 'exclamation-circle' : (type === 'success' ? 'check-circle' : 'info-circle');
            
            el.className = `${colors} text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-xs font-bold pointer-events-auto toast-enter`;
            el.innerHTML = `<i class="fas fa-${icon}"></i> <span>${msg}</span>`;
            
            container.appendChild(el);
            requestAnimationFrame(() => el.classList.add('toast-enter-active'));
            requestAnimationFrame(() => el.classList.remove('toast-enter'));
            
            setTimeout(() => {
                el.classList.add('toast-exit-active');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        };

        let db, auth;
        let isAdmin = false;
        let players = [];
        let playerErrors = {}; // Track errors for specific players
        let currentMatch = null;
        let leetifyToken = null; // Store locally after fetch
        let isUpdatingGlobal = false;
        
        let globalConfig = { 
            apiKey: null, geminiKey: null, groqKey: null, provider: 'gemini', 
            copyTitle: '', copyFooter: '', 
            aiBalanceEnabled: false, aiCoachEnabled: false,
            permissions: { add: false, edit: false, del: false, balance: false, clear: false }
        };
        
        let confirmCallback = null;

        const manualFirebaseConfig = {
            apiKey: "AIzaSyCweAYYW0_dV8iy9Zc3j3RWgJPrfIYaUP0",
            authDomain: "cs2mix.firebaseapp.com",
            projectId: "cs2mix",
            storageBucket: "cs2mix.firebasestorage.app",
            messagingSenderId: "1022628125916",
            appId: "1:1022628125916:web:50866d4b31b618e8342819",
            measurementId: "G-B8FZSQ47GM"
        };

        async function init() {
            const stored = localStorage.getItem('cs2_firebase_conf');
            let config = stored ? JSON.parse(stored) : manualFirebaseConfig;

            try {
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                if (!auth.currentUser) await signInAnonymously(auth);
            } catch(e) { console.error("Firebase Init:", e); }

            onAuthStateChanged(auth, (user) => {
                isAdmin = user && (user.email === 'hxt.dll@gmail.com');
                updateUIState();
                setupDataListeners();
            });
            
            if(config.apiKey && document.getElementById('fbApiKey')) document.getElementById('fbApiKey').value = config.apiKey;
        }

        function updateUIState() {
            const loginBtn = document.getElementById('navLoginBtn');
            const adminBtns = document.getElementById('adminControls');
            const statusLabel = document.getElementById('statusLabel');
            const statusLed = document.getElementById('statusLed');

            if(isAdmin) {
                loginBtn?.classList.add('hidden');
                adminBtns?.classList.remove('hidden');
            } else {
                loginBtn?.classList.remove('hidden');
                adminBtns?.classList.add('hidden');
            }

            if(auth?.currentUser && statusLabel && statusLed) {
                statusLabel.innerText = isAdmin ? "ADMIN" : "CONECTADO";
                statusLed.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)] animate-status";
            }
            applyPermissions();
        }

        function setupDataListeners() {
            // Players
            onSnapshot(query(collection(db, 'players')), (snapshot) => {
                players = [];
                snapshot.forEach(doc => players.push({ id: doc.id, ...doc.data() }));
                players.sort((a,b) => a.name.localeCompare(b.name));
                renderPlayerList();
            });

            // Matches
            onSnapshot(doc(db, 'matches', 'current'), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    currentMatch = data;
                    
                    // Check global updating state
                    // We look for 'updatingSince' in matches/current as a proxy since config/public might be restricted
                    if (data.updatingSince) {
                        const now = Date.now();
                        // If updating in the last 15 seconds, show loading state
                        if (now - data.updatingSince < 15000) {
                            toggleGlobalLoading(true);
                        } else {
                            toggleGlobalLoading(false);
                        }
                    } else {
                        toggleGlobalLoading(false);
                    }
                    
                    renderResults();
                } else {
                    currentMatch = null;
                    renderResults();
                }
            });

            // CONFIG PUBLIC (permissions, texts, active provider)
            onSnapshot(doc(db, 'config', 'public'), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    globalConfig = { ...globalConfig, ...data };
                    // Capture Public Leetify Token if set here
                    if(data.leetifyKey) leetifyToken = data.leetifyKey;
                    
                    // Default perm check
                    if(!globalConfig.permissions) globalConfig.permissions = { add: false, edit: false, del: false, balance: false, clear: false };
                    
                    updateConfigUI();
                    applyPermissions();
                }
            });

            // SECRETS (Keys - Admin only)
            if (isAdmin) {
                onSnapshot(doc(db, 'config', 'secrets'), (doc) => {
                    if(doc.exists()) {
                        const data = doc.data();
                        globalConfig = { ...globalConfig, ...data };
                        updateConfigUI(); 
                    }
                });
            }
        }

        function applyPermissions() {
            const p = globalConfig.permissions || {};
            const toggle = (id, allowed) => {
                const el = document.getElementById(id);
                if(el) {
                    if (isAdmin || allowed) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            };

            toggle('btnAddPlayer', p.add);
            toggle('btnBalance', p.balance);
            toggle('btnClear', p.clear);
            renderPlayerList();
        }

        function toggleGlobalLoading(isLoading) {
            const btn = document.getElementById('btnManualRefresh');
            const icon = document.getElementById('refreshIcon');
            isUpdatingGlobal = isLoading;
            
            if(isLoading) {
                btn.disabled = true;
                icon.classList.add('fa-spin');
            } else {
                btn.disabled = false;
                icon.classList.remove('fa-spin');
            }
        }

        function updateConfigUI() {
            if(isAdmin) {
                // Populate Admin Modal Inputs
                const elGemini = document.getElementById('cfgGeminiKey');
                if(elGemini) elGemini.value = globalConfig.geminiKey || '';
                
                const elGroq = document.getElementById('cfgGroqKey');
                if(elGroq) elGroq.value = globalConfig.groqKey || '';
                
                const elLeetify = document.getElementById('cfgLeetifyKey');
                if(elLeetify) elLeetify.value = globalConfig.leetifyKey || '';

                const elProvider = document.getElementById('aiProvider');
                if(elProvider) elProvider.value = globalConfig.provider || 'gemini';
                
                const elCopyTitle = document.getElementById('cfgCopyTitle');
                if(elCopyTitle) elCopyTitle.value = globalConfig.copyTitle || '';
                
                const elCopyFooter = document.getElementById('cfgCopyFooter');
                if(elCopyFooter) elCopyFooter.value = globalConfig.copyFooter || '';
                
                const elFlagAiBalance = document.getElementById('flagAiBalance');
                if(elFlagAiBalance) elFlagAiBalance.checked = globalConfig.aiBalanceEnabled;
                
                const elFlagAiCoach = document.getElementById('flagAiCoach');
                if(elFlagAiCoach) elFlagAiCoach.checked = globalConfig.aiCoachEnabled;
                
                const p = globalConfig.permissions || {};
                const elPermAdd = document.getElementById('permAdd');
                if(elPermAdd) elPermAdd.checked = p.add;
                const elPermEdit = document.getElementById('permEdit');
                if(elPermEdit) elPermEdit.checked = p.edit;
                const elPermDel = document.getElementById('permDel');
                if(elPermDel) elPermDel.checked = p.del;
                const elPermBalance = document.getElementById('permBalance');
                if(elPermBalance) elPermBalance.checked = p.balance;
                const elPermClear = document.getElementById('permClear');
                if(elPermClear) elPermClear.checked = p.clear;
            }

            const aiToggle = document.getElementById('useAiToggle');
            const aiLabel = document.getElementById('aiToggleText');
            const aiContainer = document.getElementById('aiSelectContainer');
            
            if(aiToggle && aiLabel) {
                if(globalConfig.aiBalanceEnabled) {
                    aiToggle.disabled = false;
                    aiLabel.innerText = "IA (Ativa)";
                    aiLabel.classList.remove('ai-disabled');
                } else {
                    aiToggle.disabled = true;
                    aiToggle.checked = false;
                    if(aiContainer) aiContainer.classList.add('hidden');
                    aiLabel.innerText = "IA (Dev)";
                    aiLabel.classList.add('ai-disabled');
                }
            }
            updateCoachButton(currentMatch?.analysis);
        }

        function renderPlayerList() {
            const list = document.getElementById('playersList');
            if(!list) return;
            document.getElementById('countDisplay').innerText = players.length;
            
            if(players.length === 0) {
                list.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-12 text-slate-600 border-2 border-dashed border-slate-800 rounded-xl bg-slate-900/20"><i class="fas fa-ghost text-3xl mb-3 opacity-50"></i><span class="text-sm font-medium">Lobby vazio...</span></div>`;
                return;
            }

            const p = globalConfig.permissions || {};
            const canEdit = isAdmin || p.edit;
            const canDel = isAdmin || p.del;

            list.innerHTML = players.map(pl => {
                const hasError = playerErrors[pl.id];
                // Changed: No longer adding border-red-500 to the container
                const containerClass = 'glass-panel p-3 rounded-xl flex justify-between items-center group hover:bg-slate-800/60 transition relative overflow-hidden border border-white/5';
                
                return `
                <div id="card-${pl.id}" class="${containerClass}">
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${pl.rating >= 0 ? 'bg-emerald-500/50' : 'bg-red-500/50'}"></div>
                    <div class="flex flex-col pl-2">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white text-sm tracking-wide">${pl.name}</span>
                            ${pl.url ? `<a href="${pl.url}" target="_blank" class="text-slate-600 hover:text-blue-400 transition"><i class="fas fa-link text-[10px]"></i></a>` : ''}
                            
                            <!-- Red Dot Indicator -->
                            ${hasError ? `
                                <div class="w-2 h-2 bg-red-500 rounded-full shadow-[0_0_5px_rgba(239,68,68,0.8)] ml-2" title="Falha ao atualizar"></div>
                                <button onclick="window.retryPlayer('${pl.id}')" class="bg-orange-500/10 hover:bg-orange-500/20 text-orange-400 p-1 rounded transition ml-1" title="Tentar novamente">
                                    <i class="fas fa-sync-alt text-[10px]"></i>
                                </button>
                            ` : ''}
                        </div>
                        <span class="text-[10px] font-mono text-slate-500">R: ${Number(pl.rating).toFixed(2)}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${canEdit ? `<button onclick="window.triggerEdit('${pl.id}')" class="w-7 h-7 flex items-center justify-center rounded bg-slate-800 hover:text-blue-400 text-slate-500 transition"><i class="fas fa-pencil-alt text-[10px]"></i></button>` : ''}
                        ${canDel ? `<button onclick="window.triggerDelete('${pl.id}')" class="w-7 h-7 flex items-center justify-center rounded bg-slate-800 hover:text-red-400 text-slate-500 transition"><i class="fas fa-trash text-[10px]"></i></button>` : ''}
                        ${!canEdit && !canDel ? `<span class="w-2 h-2 rounded-full bg-slate-700"></span>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // --- LEETIFY LOGIC ---

        function extractSteamId(input) {
            // Try to find a 17-digit SteamID64 in the input string
            const match = input.match(/(\d{17})/);
            return match ? match[1] : null;
        }

        async function fetchLeetifyRating(url, silent = false) {
            if (!leetifyToken) {
                if(!silent) showToast("Token Leetify não configurado", "error");
                return null;
            }

            const steamId = extractSteamId(url);
            if (!steamId) {
                if(!silent) showToast("SteamID inválido ou não encontrado no link", "error");
                return null;
            }

            try {
                const response = await fetch(`https://api-public.cs-prod.leetify.com/v3/profile?steam64_id=${steamId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${leetifyToken}`,
                        '_leetify_token': leetifyToken,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 429) {
                    console.warn(`Rate Limit hit for ${steamId}`);
                    return 'RATE_LIMIT';
                }

                if (response.status === 404) {
                    console.warn(`Player not found: ${steamId}`);
                    return null; // Just return null, don't throw
                }

                if (!response.ok) {
                    // Log detalhado para debug
                    const body = await response.text();
                    console.error("Leetify API Error", { url, status: response.status, body });
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                let rating = null;
                if (data.ranks && data.ranks.leetify !== undefined) {
                    rating = data.ranks.leetify;
                }

                return rating !== null ? parseFloat(rating) : null;

            } catch (e) {
                console.error("Leetify Fetch Exception:", e);
                if(!silent) showToast("Erro de conexão com Leetify", "error");
                return null;
            }
        }

        async function updateAllRatings() {
            if (!leetifyToken) {
                showToast("Configuração de Leetify ausente!", "error");
                return; 
            }
            
            // Tenta ativar o loading global
            const now = Date.now();
            try {
                // Usamos matches/current porque visitors geralmente têm permissão de escrita aqui
                // Diferente de config/public que costuma ser restrito
                await setDoc(doc(db, 'matches', 'current'), { updatingSince: now }, { merge: true });
            } catch (e) {
                console.warn("Não foi possível definir status global de update (Permissão?). Atualizando localmente.", e);
                // Fallback local visual
                toggleGlobalLoading(true);
            }

            // RESET VISUAL ERRORS
            playerErrors = {};
            renderPlayerList();

            showLoading(true, "Atualizando Ratings...", "Respeitando limite da API (Lento)...");
            
            try {
                const batch = writeBatch(db);
                let updateCount = 0;
                let processed = 0;
                let rateLimitHit = false;
                const failures = [];

                for (const p of players) {
                    processed++;
                    document.getElementById('loadingDesc').innerText = `Processando ${processed}/${players.length}: ${p.name}`;
                    
                    if (p.url) {
                        const newRating = await fetchLeetifyRating(p.url, true); // Silent mode
                        
                        if (newRating === 'RATE_LIMIT') {
                            rateLimitHit = true;
                            await new Promise(resolve => setTimeout(resolve, 3000));
                        } else if (newRating === null) {
                            // FAILURE - MARK CARD
                            failures.push(p.name);
                            playerErrors[p.id] = true;
                        } else if (!isNaN(newRating)) {
                            // SUCCESS
                            // Check diff locally before batch
                            if (Math.abs(newRating - p.rating) > 0.01) {
                                const ref = doc(db, 'players', p.id);
                                batch.update(ref, { rating: newRating });
                                updateCount++;
                            }
                        }
                        // Increase delay to prevent 429
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                }
                
                if (updateCount > 0) {
                    await batch.commit();
                    showToast(`${updateCount} ratings atualizados!`, "success");
                } 
                
                if (failures.length > 0) {
                    renderPlayerList(); // Update UI to show errors
                    showToast(`Falha ao atualizar: ${failures.join(', ')}`, "error");
                } else if (!rateLimitHit && updateCount === 0) {
                    showToast("Todos ratings já atualizados.", "success");
                }

            } catch(e) {
                console.error(e);
                showToast("Erro na fila de atualização.", "error");
            } finally {
                // Clear Global Loading
                try {
                    await setDoc(doc(db, 'matches', 'current'), { updatingSince: null }, { merge: true });
                } catch(e) { console.warn("Erro ao limpar status global", e); }
                
                toggleGlobalLoading(false);
                showLoading(false);
            }
        }
        
        window.retryPlayer = async (id) => {
            const p = players.find(x => x.id === id);
            if(!p) return;
            
            const btn = document.getElementById(`card-${id}`).querySelector('button');
            if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            const newRating = await fetchLeetifyRating(p.url);
            
            if (newRating !== null && !isNaN(newRating)) {
                await setDoc(doc(db, 'players', id), { rating: newRating }, { merge: true });
                // Clear error
                delete playerErrors[id];
                renderPlayerList();
                showToast(`Rating de ${p.name} atualizado!`, "success");
            } else {
                showToast("Falha ao atualizar. Verifique Console.", "error");
                if(btn) btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            }
        };


        // --- GLOBAL FUNCTIONS ---
        window.toggleLoginModal = () => {
            const el = document.getElementById('loginModal');
            if(el.classList.contains('active')) {
                el.classList.remove('active');
            } else {
                el.classList.add('active');
                const u = localStorage.getItem('cs2_user');
                if(u) { document.getElementById('adminUser').value = u; document.getElementById('rememberMe').checked = true; }
            }
        };

        window.openConfig = () => {
            // Force Update UI first
            updateConfigUI();
            window.openModal('configModal');
        };

        window.saveConfig = async function() {
            if(!isAdmin) return showToast("Apenas admin pode salvar.", "error");
            
            // 1. PUBLIC Data (config/public)
            const publicUpdates = {
                copyTitle: document.getElementById('cfgCopyTitle').value.trim(),
                copyFooter: document.getElementById('cfgCopyFooter').value.trim(),
                aiBalanceEnabled: document.getElementById('flagAiBalance').checked,
                aiCoachEnabled: document.getElementById('flagAiCoach').checked,
                provider: document.getElementById('aiProvider').value, 
                leetifyKey: document.getElementById('cfgLeetifyKey').value.trim(), // Public now
                permissions: {
                    add: document.getElementById('permAdd').checked,
                    edit: document.getElementById('permEdit').checked,
                    del: document.getElementById('permDel').checked,
                    balance: document.getElementById('permBalance').checked,
                    clear: document.getElementById('permClear').checked
                }
            };

            // 2. SECRET Data (config/secrets)
            const privateUpdates = {
                geminiKey: document.getElementById('cfgGeminiKey').value.trim(),
                groqKey: document.getElementById('cfgGroqKey').value.trim()
            };
            
            const fbKey = document.getElementById('fbApiKey').value.trim();
            if(fbKey) localStorage.setItem('cs2_firebase_conf', JSON.stringify({apiKey: fbKey}));

            try {
                // Save both docs
                await setDoc(doc(db, 'config', 'public'), publicUpdates, { merge: true });
                await setDoc(doc(db, 'config', 'secrets'), privateUpdates, { merge: true });
                
                window.closeModal('configModal');
                showToast("Configurações salvas!", "success");
            } catch(e) { console.error(e); showToast("Erro ao salvar.", "error"); }
        }

        window.checkLogin = async function() {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            const remember = document.getElementById('rememberMe').checked;
            const email = u.includes('@') ? u : (u === 'hxt' ? 'hxt.dll@gmail.com' : u);
            
            try {
                await setPersistence(auth, browserLocalPersistence);
                await signInWithEmailAndPassword(auth, email, p);
                if(remember) localStorage.setItem('cs2_user', u); else localStorage.removeItem('cs2_user');
                
                document.getElementById('loginModal').classList.remove('active');
                showToast("Login realizado!", "success");
            } catch(e) { console.error(e); showToast("Erro no login.", "error"); }
        }

        window.performLogout = async () => { await signOut(auth); await signInAnonymously(auth); showToast("Desconectado."); };
        
        window.manualRefresh = async () => {
            if(isUpdatingGlobal) return;
            const icon = document.getElementById('refreshIcon');
            if(icon) icon.classList.add('fa-spin');
            
            // Trigger API update for all (Manual Refresh always updates)
            await updateAllRatings();

            if(icon) setTimeout(() => icon.classList.remove('fa-spin'), 1000);
        };
        
        window.openAddPlayerModal = () => {
             document.getElementById('playerId').value = '';
             document.getElementById('inputName').value = '';
             document.getElementById('inputUrl').value = '';
             document.getElementById('inputRating').value = '';
             document.getElementById('modalTitle').innerText = "Adicionar Jogador";
             window.toggleHelpView(false);
             window.openModal('playerModal');
        };
        
        window.toggleHelpView = (show) => {
            const view = document.getElementById('playerHelpView');
            if(show) view.classList.remove('hidden'); else view.classList.add('hidden');
        };
        
        window.toggleAiSelect = () => {
             const chk = document.getElementById('useAiToggle');
             const sel = document.getElementById('aiSelectContainer');
             if(chk.checked) sel.classList.remove('hidden'); else sel.classList.add('hidden');
        };

        window.savePlayer = async () => {
            const name = document.getElementById('inputName').value.trim();
            const url = document.getElementById('inputUrl').value.trim();
            const id = document.getElementById('playerId').value || 'p_' + Date.now();
            
            // Rating input can be overwritten by API
            let rating = parseFloat(document.getElementById('inputRating').value);

            if (!name) return showToast("Nome obrigatório", "error");
            // URL not mandatory for manual entry if they just want to input rating, but prompted as mandatory
            if (!url) return showToast("Link Leetify/Steam obrigatório", "error");
            
            // Show Loading
            const btn = document.querySelector('#playerModal button');
            const originalText = btn.innerText;
            btn.innerText = "Consultando Leetify...";
            btn.disabled = true;

            // Try Fetching Rating
            const fetchedRating = await fetchLeetifyRating(url, true); // Silent fetch
            if (fetchedRating !== null && typeof fetchedRating === 'number') {
                rating = fetchedRating;
                showToast(`Rating atualizado: ${rating}`, "success");
            } else if (isNaN(rating)) {
                // If fetch failed AND manual input is empty
                btn.innerText = originalText;
                btn.disabled = false;
                return showToast("Falha na API e sem rating manual", "error");
            } else {
                // Fetch failed but we have manual rating
                showToast("API Falhou - Usando rating manual", "info");
            }

            try {
                await setDoc(doc(db, 'players', id), { name, url, rating, id }, { merge: true });
                
                // Clear error status for this player immediately
                if (playerErrors[id]) {
                    delete playerErrors[id];
                    renderPlayerList();
                }

                window.closeModal('playerModal');
                // showToast("Jogador salvo!", "success"); // Already showed toast above or redundant
            } catch(e) { showToast("Erro ao salvar", "error"); }
            
            btn.innerText = originalText;
            btn.disabled = false;
        };

        window.triggerDelete = (id) => {
            document.getElementById('confirmMessage').innerText = "Remover este jogador?";
            confirmCallback = async () => { await deleteDoc(doc(db, 'players', id)); showToast("Removido.", "success"); };
            window.openModal('confirmModal');
        };
        document.getElementById('btnConfirmYes').onclick = () => { if(confirmCallback) confirmCallback(); window.closeModal('confirmModal'); };

        window.triggerEdit = (id) => { 
            const p = players.find(x => x.id === id); 
            if(p) {
                document.getElementById('playerId').value = p.id;
                document.getElementById('inputName').value = p.name;
                document.getElementById('inputUrl').value = p.url;
                document.getElementById('inputRating').value = p.rating;
                document.getElementById('modalTitle').innerText = "Editar Jogador";
                window.toggleHelpView(false);
                window.openModal('playerModal');
            }
        };
        
        window.clearCurrentMatch = async () => { await setDoc(doc(db, 'matches', 'current'), { teamA: [], teamB: [] }); };

        // Helper for modal loading
        function showLoading(show, title, desc) {
            const m = document.getElementById('loadingModal');
            if(show) {
                document.getElementById('loadingTitle').innerText = title || "Calculando...";
                document.getElementById('loadingDesc').innerText = desc || "";
                m.classList.remove('hidden');
                m.classList.add('flex');
            } else {
                m.classList.add('hidden');
                m.classList.remove('flex');
            }
        }

        window.handleBalance = async () => {
            if(players.length < 10) return showToast("Mínimo 10 jogadores", "error");
            
            const aiToggle = document.getElementById('useAiToggle');
            const useAi = aiToggle ? aiToggle.checked : false;
            
            // CHECK AUTO-UPDATE Checkbox
            const shouldUpdate = document.getElementById('chkAutoUpdate').checked;
            
            if (shouldUpdate) {
                await updateAllRatings();
            }

            showLoading(true, "Equilibrando...", "Calculando as melhores combinações...");
            
            // Small delay to allow UI to render the loading state properly
            setTimeout(async () => {
                const pool = [...players].sort(()=>Math.random()-0.5);
                const active = pool.slice(0,10);
                const reserves = pool.slice(10);
                
                if (useAi && globalConfig.aiBalanceEnabled) {
                    performAiBalance(active, reserves);
                } else {
                    // Math fallback logic
                    const combinations = (arr, k) => {
                        const res = [];
                        const f = (start, combo) => {
                            if(combo.length===k) { res.push(combo); return; }
                            for(let i=start; i<arr.length; i++) f(i+1, [...combo, arr[i]]);
                        };
                        f(0,[]);
                        return res;
                    };
                    const combos = combinations(active, 5);
                    const target = active.reduce((a,b)=>a+Number(b.rating),0)/2;
                    combos.sort((a,b) => Math.abs(a.reduce((x,y)=>x+y.rating,0)-target) - Math.abs(b.reduce((x,y)=>x+y.rating,0)-target));
                    const tA = combos[0];
                    const tB = active.filter(p => !tA.some(x=>x.id===p.id));
                    
                    await setDoc(doc(db, 'matches', 'current'), { teamA: tA, teamB: tB, reserves, analysis: null });
                    showLoading(false);
                }
            }, 500);
        };

        async function performAiBalance(active, reserves) {
            // Determine active key based on provider
            let activeKey = null;
            if (globalConfig.provider === 'groq') activeKey = globalConfig.groqKey;
            else activeKey = globalConfig.geminiKey;

            // Security check: If key is missing (Visitor), fallback to Math
            // OR if Admin but keys weren't saved in 'secrets' yet (fallback to legacy 'apiKey' if any)
            if (!activeKey) {
                // Try legacy
                activeKey = globalConfig.apiKey;
            }

            if (!activeKey) {
                showLoading(false);
                showToast("Chave da IA não encontrada (Visitantes não têm acesso).", "error");
                
                // Fallback to math
                const aiToggle = document.getElementById('useAiToggle');
                if(aiToggle) aiToggle.checked = false;
                window.handleBalance(); 
                return;
            }
            
            try {
                // Prepare prompt
                const promptText = `
                Divide these 10 players into two balanced 5v5 teams for CS2.
                Minimize rating difference between teams.
                Players: ${active.map(p => `{"id":"${p.id}","rating":${p.rating}}`).join(',')}
                Output JSON ONLY: {"teamA_ids": ["id1"...], "teamB_ids": ["id6"...]}
                `;

                const response = await fetchAi(promptText, true, activeKey);
                let jsonStr = response.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(jsonStr);
                
                const teamA = active.filter(p => json.teamA_ids.includes(p.id));
                const teamB = active.filter(p => json.teamB_ids.includes(p.id));
                
                if (teamA.length !== 5 || teamB.length !== 5) throw new Error("IA retornou times inválidos");
                
                await setDoc(doc(db, 'matches', 'current'), {
                    teamA, teamB, reserves, timestamp: new Date().toISOString(), analysis: null
                });
                
                showLoading(false);

            } catch (e) {
                console.error(e);
                showToast("Erro na IA: " + e.message, "error");
                // Fallback
                const aiToggle = document.getElementById('useAiToggle');
                if(aiToggle) aiToggle.checked = false;
                window.handleBalance(); 
            }
        }

        async function fetchAi(prompt, jsonMode, key) {
             const isGroq = globalConfig.provider === 'groq';
             let url, body, headers = { 'Content-Type': 'application/json' };
             
             if (isGroq) {
                 url = 'https://api.groq.com/openai/v1/chat/completions';
                 headers['Authorization'] = `Bearer ${key}`;
                 body = JSON.stringify({
                     model: "llama-3.3-70b-versatile",
                     messages: [{ role: "user", content: prompt }],
                     response_format: jsonMode ? { type: "json_object" } : { type: "text" }
                 });
             } else {
                 url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
                 body = JSON.stringify({
                     contents: [{ parts: [{ text: prompt }] }],
                     generationConfig: { responseMimeType: jsonMode ? "application/json" : "text/plain" }
                 });
             }
             
             const res = await fetch(url, { method: 'POST', headers, body });
             const data = await res.json();
             
             if(!res.ok) {
                 const errDetail = data.error?.message || res.statusText;
                 throw new Error(`API Error (${res.status}): ${errDetail}`);
             }
             
             if (isGroq) return data.choices[0].message.content;
             return data.candidates[0].content.parts[0].text;
        }

        window.handleAiCoach = async () => { showToast("Funcionalidade em manutenção", "error"); };
        
        window.prepareCopy = () => {
             if(!currentMatch?.teamA?.length) return showToast("Nada para copiar", "error");
             
             const avgA = currentMatch.teamA.reduce((a,b)=>a+Number(b.rating),0)/5;
             const avgB = currentMatch.teamB.reduce((a,b)=>a+Number(b.rating),0)/5;
             const tA = currentMatch.teamA.map(p=>`> 👮 *${p.name}* (${p.rating})`).join('\n');
             const tB = currentMatch.teamB.map(p=>`> 🏴‍☠️ *${p.name}* (${p.rating})`).join('\n');
             let resTxt = "";
             if (currentMatch.reserves && currentMatch.reserves.length) resTxt = `\n\n🛑 **RESERVAS:**\n` + currentMatch.reserves.map(p => p.name).join(', ');

             const text = `${globalConfig.copyTitle || '**CS2 MIX**'}\n\n🔵 **Time A** (Avg: ${avgA.toFixed(2)})\n${tA}\n\n🟠 **Time B** (Avg: ${avgB.toFixed(2)})\n${tB}${resTxt}\n\n${globalConfig.copyFooter || ''}`;
             
             document.getElementById('copyPreviewText').innerText = text;
             window.toggleIsland('copy');
        };
        
        window.confirmCopy = () => {
             const txt = document.getElementById('copyPreviewText').innerText;
             const copySuccess = () => {
                showToast("Texto copiado!", "success");
                window.toggleIsland(null);
             };
             
             if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(txt).then(copySuccess).catch(() => fallbackCopy(txt));
             } else {
                fallbackCopy(txt);
             }
        };

        function fallbackCopy(text) {
            const ta = document.createElement("textarea");
            ta.value = text;
            ta.style.position = "fixed"; ta.style.left = "-9999px";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            try {
                document.execCommand('copy');
                showToast("Texto copiado (Fallback)!", "success");
                window.toggleIsland(null);
            } catch (err) {
                showToast("Erro ao copiar", "error");
            }
            document.body.removeChild(ta);
        }

        function renderResults() {
            const resArea = document.getElementById('resultsArea');
            const placeArea = document.getElementById('placeholderResult');
            
            if(!currentMatch || !currentMatch.teamA || currentMatch.teamA.length === 0) {
                if(resArea) resArea.classList.add('hidden');
                if(placeArea) placeArea.classList.remove('hidden');
                return;
            }
            
            if(resArea) resArea.classList.remove('hidden');
            if(placeArea) placeArea.classList.add('hidden');
            
            const teamA = currentMatch.teamA;
            const teamB = currentMatch.teamB;
            const reserves = currentMatch.reserves;
            
            const render = (arr) => arr.map(p => `
                <div class="flex justify-between items-center py-2 px-2 border-b border-white/5 last:border-0 hover:bg-white/5 transition rounded-sm">
                    <span class="text-xs font-medium text-slate-200 truncate max-w-[120px]">${p.name}</span>
                    <span class="font-mono text-[10px] ${p.rating >= 0 ? 'text-emerald-400' : 'text-red-400'}">${p.rating > 0 ? '+' : ''}${Number(p.rating).toFixed(2)}</span>
                </div>`).join('');
                
            const listA = document.getElementById('listA');
            const listB = document.getElementById('listB');
            if(listA) listA.innerHTML = render(teamA);
            if(listB) listB.innerHTML = render(teamB);
            
            const avgA = teamA.reduce((a,b)=>a+Number(b.rating),0)/5;
            const avgB = teamB.reduce((a,b)=>a+Number(b.rating),0)/5;
            
            const elAvgA = document.getElementById('avgA');
            const elAvgB = document.getElementById('avgB');
            const elDiff = document.getElementById('diffBadge');
            
            if(elAvgA) elAvgA.innerText = "Avg: " + avgA.toFixed(2);
            if(elAvgB) elAvgB.innerText = "Avg: " + avgB.toFixed(2);
            if(elDiff) elDiff.innerText = `Diff: ${Math.abs(avgA-avgB).toFixed(2)}`;
            
            const resBox = document.getElementById('reservesBox');
            const listRes = document.getElementById('listReserves');
            
            if (reserves && reserves.length > 0) {
                if(resBox) resBox.classList.remove('hidden');
                if(listRes) listRes.innerHTML = reserves.map(p => 
                    `<div class="bg-slate-800/80 px-2 py-1 rounded text-[10px] text-slate-400 border border-slate-700 shadow-sm">${p.name}</div>`
                ).join('');
            } else {
                if(resBox) resBox.classList.add('hidden');
            }
            
            updateCoachButton(currentMatch.analysis);
        }

        function updateCoachButton(hasAnalysis) {
            const btn = document.getElementById('coachBtn');
            const txt = document.getElementById('coachBtnText');
            if(!btn || !txt) return;
            
            if (globalConfig.aiCoachEnabled) {
                btn.disabled = false;
                // REMOVING both Tailwind disabled modifiers AND the base class
                btn.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed', 'cursor-not-allowed');
                
                if(hasAnalysis) {
                    txt.innerText = "LER ANÁLISE SALVA";
                    btn.classList.add('border-purple-500/50');
                } else {
                    txt.innerText = "ANÁLISE DO COACH IA";
                    btn.classList.remove('border-purple-500/50');
                }
            } else {
                btn.disabled = true;
                btn.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed', 'cursor-not-allowed');
                txt.innerText = "COACH IA (INDISPONÍVEL)";
            }
        }

        // Generic Modal Logic
        window.openModal = (id) => {
            const m = document.getElementById(id);
            if(!m) return;
            m.classList.remove('hidden');
            // Adding flex to ensure centering works for fixed modals
            m.classList.add('flex');
            setTimeout(() => {
                m.classList.remove('backdrop-blur-sm'); m.classList.add('backdrop-blur-sm');
                m.querySelector('.modal-content')?.classList.remove('scale-95', 'opacity-0');
                m.querySelector('.modal-content')?.classList.add('scale-100', 'opacity-100');
            }, 10);
        };
        window.closeModal = (id) => {
            const m = document.getElementById(id);
            if(!m) return;
            m.querySelector('.modal-content')?.classList.remove('scale-100', 'opacity-100');
            m.querySelector('.modal-content')?.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                m.classList.add('hidden');
                m.classList.remove('flex');
            }, 200);
        };
        
        window.toggleIsland = (type) => {
            const loginIsland = document.getElementById('loginModal');
            const copyIsland = document.getElementById('islandCopy');
            
            if(type === 'login') {
                copyIsland?.classList.remove('active');
                loginIsland?.classList.toggle('active');
            } else if(type === 'copy') {
                loginIsland?.classList.remove('active');
                copyIsland?.classList.toggle('active');
            } else {
                loginIsland?.classList.remove('active');
                copyIsland?.classList.remove('active');
            }
        };

        init();
    </script>
</body>
</html>
